{% extends "base.html" %}
{% load static %}

{% block title %}記事編集 - HPB Blog Automation{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-6 lg:px-8 py-10">
    <!-- Header -->
    <header class="mb-10">
        <a href="{% url 'blog:post_detail' pk=post.pk %}" 
           class="inline-flex items-center text-body text-gray-500 hover:text-gray-900 transition-colors mb-4">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            詳細に戻る
        </a>
        <h1 class="text-display text-gray-900 mb-2">記事編集</h1>
        <p class="text-body text-gray-500">記事の内容を編集できます</p>
    </header>
    
    <form method="post" class="space-y-8">
        {% csrf_token %}

        <!-- Edit Content -->
        <section class="card">
            <h2 class="text-title text-gray-900 mb-6">記事内容</h2>

            <div class="space-y-6">
                <div>
                    <label for="title" class="block text-body font-medium text-gray-700 mb-2">
                        タイトル
                        <span class="text-pink-500">*</span>
                        <span class="text-caption text-gray-400 font-normal ml-1">(最大25文字)</span>
                    </label>
                    <input type="text" id="title" name="title" maxlength="25"
                           value="{{ post.title|default:'' }}" required>
                    <p class="text-caption text-gray-500 mt-1.5">
                        <span id="title-count">0</span> / 25文字
                    </p>
                    <p id="title-error" class="text-caption text-red-600 mt-1.5 hidden">タイトルは必須です。</p>
                </div>

                <div>
                    <label for="content" class="block text-body font-medium text-gray-700 mb-2">
                        本文
                        <span class="text-caption text-gray-400 font-normal ml-1">(最大1000文字)</span>
                    </label>
                    <textarea id="content" name="content" rows="16" maxlength="1000">{{ post.content|default:'' }}</textarea>
                    <p class="text-caption text-gray-500 mt-1.5">
                        <span id="content-count">0</span> / 1000文字
                    </p>
                    <p id="content-error" class="text-caption text-red-600 mt-1.5 hidden">本文は1000文字以内にしてください。</p>
                </div>

                <!-- Template Selection -->
                {% if templates %}
                <div class="mt-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
                    <label for="template-select" class="block text-body font-medium text-blue-900 mb-2">
                        テンプレートを追加
                    </label>
                    <p class="text-caption text-blue-700 mb-3">
                        保存済みのテンプレートを本文の最後に追加できます
                    </p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <select id="template-select" class="flex-1">
                            <option value="">-- テンプレートを選択 --</option>
                            {% for template in templates %}
                            <option value="{{ template.id }}" data-content="{{ template.content|escapejs }}">
                                {{ template.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" id="add-template-btn" class="btn btn-secondary">
                            追加
                        </button>
                    </div>
                    <div id="template-preview" class="mt-3 p-3 rounded bg-white border border-blue-200 hidden">
                        <p class="text-caption text-gray-500 mb-2">プレビュー:</p>
                        <p id="template-preview-content" class="text-caption text-gray-700 whitespace-pre-wrap"></p>
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        {% if images %}
        <section class="card">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                <h2 class="text-title text-gray-900">画像の並び替え</h2>
                <p class="text-caption text-gray-400">ドラッグ＆ドロップで順番変更（自動保存）</p>
            </div>
            <div id="image-reorder-list" class="grid grid-cols-2 sm:grid-cols-4 gap-4" data-post-id="{{ post.pk }}">
                {% for image in images %}
                <div class="relative group cursor-move" draggable="true"
                     data-image-id="{{ image.id }}" data-image-url="{{ image.image_url }}">
                    <img src="{{ image.image_url }}" alt="画像 {{ image.order }}"
                         class="w-full aspect-square object-cover rounded-lg border border-gray-200">
                    <div
                        class="absolute top-2 left-2 w-6 h-6 bg-pink-500 rounded-full flex items-center justify-center text-xs font-medium text-white shadow-sm image-order-badge">
                        {{ forloop.counter }}
                    </div>
                    <div class="absolute top-2 right-2 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center text-gray-500 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 9h16M4 15h16"></path>
                        </svg>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <section class="card">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                <h2 class="text-title text-gray-900">プレビュー</h2>
                <p class="text-caption text-gray-400">保存前に表示を確認できます</p>
            </div>
            <div class="space-y-3">
                <h3 id="preview-title" class="text-title text-gray-900"></h3>
                <div id="preview-content" class="text-body text-gray-700 whitespace-pre-wrap leading-relaxed"></div>
            </div>
        </section>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-4">
            <button type="submit" class="btn btn-primary flex-1 sm:flex-none">
                保存
            </button>
            <a href="{% url 'blog:post_detail' pk=post.pk %}" class="btn btn-secondary flex-1 sm:flex-none text-center">
                キャンセル
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.getElementById('title');
        const titleCount = document.getElementById('title-count');
        const contentTextarea = document.getElementById('content');
        const contentCount = document.getElementById('content-count');
        const submitBtn = document.querySelector('button[type="submit"]');
        const titleError = document.getElementById('title-error');
        const contentError = document.getElementById('content-error');
        let hasTriedSubmit = false;

        function setFieldError(field, errorEl, message, show) {
            if (!field || !errorEl) return;
            if (show) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                field.classList.add('border-red-500', 'ring-1', 'ring-red-500/20');
                field.setAttribute('aria-invalid', 'true');
            } else {
                errorEl.classList.add('hidden');
                field.classList.remove('border-red-500', 'ring-1', 'ring-red-500/20');
                field.removeAttribute('aria-invalid');
            }
        }

        // Update title character count
        function updateTitleCount() {
            const count = titleInput.value.length;
            titleCount.textContent = count;

            // Change color based on character count
            if (count > 25) {
                titleCount.classList.add('text-red-600', 'font-medium');
                titleCount.classList.remove('text-gray-500');
            } else if (count > 22) {
                titleCount.classList.add('text-yellow-600', 'font-medium');
                titleCount.classList.remove('text-gray-500', 'text-red-600');
            } else {
                titleCount.classList.add('text-gray-500');
                titleCount.classList.remove('text-yellow-600', 'text-red-600', 'font-medium');
            }
        }

        // Update content character count
        function updateContentCount() {
            const count = contentTextarea.value.length;
            contentCount.textContent = count;

            // Change color based on character count
            if (count > 1000) {
                contentCount.classList.add('text-red-600', 'font-medium');
                contentCount.classList.remove('text-gray-500');
            } else if (count > 900) {
                contentCount.classList.add('text-yellow-600', 'font-medium');
                contentCount.classList.remove('text-gray-500', 'text-red-600');
            } else {
                contentCount.classList.add('text-gray-500');
                contentCount.classList.remove('text-yellow-600', 'text-red-600', 'font-medium');
            }
        }

        function validateForm(showErrors = false) {
            const titleValue = titleInput.value.trim();
            const contentValue = contentTextarea.value;
            const titleMissing = titleValue.length === 0;
            const titleTooLong = titleValue.length > 25;
            const contentTooLong = contentValue.length > 1000;

            const titleErrorMessage = titleMissing
                ? 'タイトルは必須です。'
                : 'タイトルは25文字以内にしてください。';

            setFieldError(
                titleInput,
                titleError,
                titleErrorMessage,
                titleTooLong || (showErrors && titleMissing)
            );
            setFieldError(contentTextarea, contentError, '本文は1000文字以内にしてください。', contentTooLong);

            const isValid = !titleMissing && !titleTooLong && !contentTooLong;
            submitBtn.disabled = !isValid;
            if (!isValid) {
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            return isValid;
        }

        // Initialize counts on page load
        updateTitleCount();
        updateContentCount();
        validateForm();

        // Update counts on input
        titleInput.addEventListener('input', () => {
            updateTitleCount();
            validateForm(hasTriedSubmit);
        });
        contentTextarea.addEventListener('input', () => {
            updateContentCount();
            validateForm(hasTriedSubmit);
        });

        // Prevent form submission if validation fails
        document.querySelector('form').addEventListener('submit', function(e) {
            hasTriedSubmit = true;
            if (!validateForm(true)) {
                e.preventDefault();
                if (!titleInput.value.trim()) {
                    titleInput.focus();
                } else if (titleInput.value.trim().length > 25) {
                    titleInput.focus();
                } else if (contentTextarea.value.length > 1000) {
                    contentTextarea.focus();
                }
                return false;
            }
        });

        // Template selection functionality
        const templateSelect = document.getElementById('template-select');
        const addTemplateBtn = document.getElementById('add-template-btn');
        const templatePreview = document.getElementById('template-preview');
        const templatePreviewContent = document.getElementById('template-preview-content');

        if (templateSelect && addTemplateBtn) {
            // Show preview when template is selected
            templateSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const templateContent = selectedOption.getAttribute('data-content');

                if (templateContent) {
                    templatePreviewContent.textContent = templateContent;
                    templatePreview.classList.remove('hidden');
                } else {
                    templatePreview.classList.add('hidden');
                }
            });

            // Add template to content
            addTemplateBtn.addEventListener('click', async function() {
                const selectedOption = templateSelect.options[templateSelect.selectedIndex];
                const templateContent = selectedOption.getAttribute('data-content');

                if (!templateContent) {
                    await window.dialog.alert('テンプレート未選択', 'テンプレートを選択してください。');
                    return;
                }

                // Check if adding template will exceed limit
                const currentContent = contentTextarea.value;
                const separator = currentContent && !currentContent.endsWith('\n') ? '\n\n' : '\n';
                const newContent = currentContent + separator + templateContent;

                if (newContent.length > 1000) {
                    await window.dialog.alert('文字数超過', 'テンプレートを追加すると1000文字を超えてしまいます。本文を短くしてから追加してください。');
                    return;
                }

                // Add template to content
                contentTextarea.value = newContent;
                updateContentCount();
                validateForm(hasTriedSubmit);
                renderPreview();

                // Reset selection
                templateSelect.selectedIndex = 0;
                templatePreview.classList.add('hidden');

                // Show success message
                window.toast.success('テンプレートを追加しました');
            });
        }

        const previewTitle = document.getElementById('preview-title');
        const previewContent = document.getElementById('preview-content');
        const imageReorderList = document.getElementById('image-reorder-list');

        function getOrderedImages() {
            if (!imageReorderList) return [];
            return Array.from(imageReorderList.querySelectorAll('[data-image-id]')).map(item => ({
                id: Number(item.dataset.imageId),
                url: item.dataset.imageUrl
            }));
        }

        function updateOrderBadges() {
            if (!imageReorderList) return;
            Array.from(imageReorderList.querySelectorAll('.image-order-badge')).forEach((badge, index) => {
                badge.textContent = index + 1;
            });
        }

        function renderPreview() {
            if (!previewTitle || !previewContent) return;

            previewTitle.textContent = titleInput.value.trim() || '（タイトル未設定）';
            previewContent.textContent = '';

            const content = contentTextarea.value || '';
            if (!content.trim()) {
                previewContent.textContent = '（本文未入力）';
                return;
            }

            const images = getOrderedImages();
            const regex = /\{\{image_(\d+)\}\}/g;
            let lastIndex = 0;
            let match;

            while ((match = regex.exec(content)) !== null) {
                const textPart = content.slice(lastIndex, match.index);
                if (textPart) {
                    previewContent.appendChild(document.createTextNode(textPart));
                }

                const imageIndex = Number(match[1]) - 1;
                const image = images[imageIndex];
                if (image && image.url) {
                    const img = document.createElement('img');
                    img.src = image.url;
                    img.alt = `画像 ${imageIndex + 1}`;
                    img.className = 'block w-full max-w-sm mx-auto rounded-lg my-3';
                    previewContent.appendChild(img);
                } else {
                    const placeholder = document.createElement('span');
                    placeholder.textContent = match[0];
                    placeholder.className = 'text-gray-400';
                    previewContent.appendChild(placeholder);
                }

                lastIndex = match.index + match[0].length;
            }

            const tail = content.slice(lastIndex);
            if (tail) {
                previewContent.appendChild(document.createTextNode(tail));
            }
        }

        if (previewTitle && previewContent) {
            renderPreview();
            ['input', 'change', 'keyup', 'compositionend'].forEach(eventName => {
                titleInput.addEventListener(eventName, renderPreview);
                contentTextarea.addEventListener(eventName, renderPreview);
            });
        }

        if (imageReorderList) {
            let draggedItem = null;
            let lastSignature = getOrderedImages().map(img => img.id).join(',');
            const postId = imageReorderList.dataset.postId;
            const saveOrder = debounce(async () => {
                if (!postId) return;
                const orders = getOrderedImages().map((img, index) => ({
                    id: img.id,
                    order: index
                }));

                try {
                    await api.post('/blog/images/reorder/', {
                        post_id: Number(postId),
                        orders
                    });
                    window.toast.success('画像の並び順を保存しました');
                } catch (error) {
                    window.toast.error(`画像の並び順の保存に失敗しました: ${error.message}`);
                }
            }, 300);

            imageReorderList.addEventListener('dragstart', (event) => {
                const item = event.target.closest('[data-image-id]');
                if (!item) return;
                draggedItem = item;
                item.classList.add('opacity-60');
                event.dataTransfer.effectAllowed = 'move';
            });

            imageReorderList.addEventListener('dragend', () => {
                if (!draggedItem) return;
                draggedItem.classList.remove('opacity-60');
                draggedItem = null;
                const signature = getOrderedImages().map(img => img.id).join(',');
                if (signature !== lastSignature) {
                    lastSignature = signature;
                    updateOrderBadges();
                    renderPreview();
                    saveOrder();
                }
            });

            imageReorderList.addEventListener('dragover', (event) => {
                event.preventDefault();
                const target = event.target.closest('[data-image-id]');
                if (!target || target === draggedItem) return;
                const rect = target.getBoundingClientRect();
                const insertAfter = (event.clientY - rect.top) > rect.height / 2;
                imageReorderList.insertBefore(draggedItem, insertAfter ? target.nextSibling : target);
            });
        }
    });
</script>
{% endblock %}
