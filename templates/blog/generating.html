{% extends "base.html" %}
{% load static %}

{% block title %}AI記事生成中 - HPB Blog Automation{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-6 lg:px-8 py-10">
    <!-- Header -->
    <header class="mb-10 text-center">
        <h1 class="text-display text-gray-900 mb-4">AI記事生成中</h1>
        <p class="text-body text-gray-500">3つの記事案を生成しています。少々お待ちください...</p>
    </header>
    
    <!-- Progress Card -->
    <div class="card">
        <div class="flex flex-col items-center py-8">
            <!-- Spinner -->
            <div class="relative mb-8">
                <div class="w-20 h-20 border-4 border-gray-200 rounded-full"></div>
                <div class="absolute top-0 left-0 w-20 h-20 border-4 border-pink-500 rounded-full border-t-transparent animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-8 h-8 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
            </div>
            
            <!-- Progress Text -->
            <div id="progress-container" class="w-full max-w-md">
                <div class="flex justify-between text-caption text-gray-500 mb-2">
                    <span id="progress-message">準備中...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-pink-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Info -->
            <div class="mt-8 text-center">
                <p class="text-caption text-gray-400 mb-4">
                    キーワード: <span class="text-gray-600">{{ post.keywords }}</span>
                </p>
                <div class="flex items-center justify-center space-x-2 text-caption text-gray-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>通常30〜1分程度かかります</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Link -->
    <div class="mt-6 text-center">
        <a href="{% url 'blog:post_list' %}" class="text-caption text-gray-500 hover:text-gray-700 transition-colors">
            キャンセルして一覧に戻る
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const postId = {{ post.pk }};
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        const progressPercent = document.getElementById('progress-percent');
        
        // Connect to WebSocket
        window.blogWS.connect(postId);
        
        // Update progress
        window.blogWS.on('task_progress', (data) => {
            const percent = data.progress || 0;
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            if (data.message) {
                progressMessage.textContent = data.message;
            }
        });
        
        // Handle completion - redirect to selection page
        window.blogWS.on('task_completed', (data) => {
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressMessage.textContent = '生成完了！選択画面に移動します...';
            
            setTimeout(() => {
                if (data.result && data.result.redirect_url) {
                    window.location.href = data.result.redirect_url;
                } else {
                    window.location.href = `/blog/posts/${postId}/select/`;
                }
            }, 1000);
        });
        
        // Handle failure
        window.blogWS.on('task_failed', (data) => {
            progressMessage.textContent = 'エラーが発生しました';
            progressPercent.textContent = '';
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-pink-500');
            progressBar.classList.add('bg-red-500');
            
            setTimeout(() => {
                window.location.href = `/blog/posts/${postId}/`;
            }, 2000);
        });
        
        // Poll for status changes (fallback if WebSocket fails)
        let pollInterval = setInterval(() => {
            fetch(`/api/blog/posts/${postId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'selecting') {
                        clearInterval(pollInterval);
                        window.location.href = `/blog/posts/${postId}/select/`;
                    } else if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        window.location.href = `/blog/posts/${postId}/`;
                    } else if (data.status === 'ready' || data.status === 'published') {
                        clearInterval(pollInterval);
                        window.location.href = `/blog/posts/${postId}/`;
                    }
                })
                .catch(err => console.error('Polling error:', err));
        }, 3000);
    });
</script>
{% endblock %}
